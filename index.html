<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zenbakien Jauziak Mariorekin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --mario-red: #E52521;
            --mario-blue: #3A5CFF;
            --mario-yellow: #F7B000;
            --mario-brown: #7E2500;
            --sky-blue: #5C94FC;
            --grass-green: #4CAF50;
            --block-size: clamp(60px, 18vw, 100px);
            --font-family: 'Press Start 2P', cursive;
        }

        /* Estilos generales y de fondo */
        body {
            font-family: var(--font-family);
            background-color: var(--sky-blue);
            background-image: 
                url('https://www.transparentpng.com/thumb/mario/aT5K6w-super-mario-bros-cloud-transparent-background.png'),
                url('https://www.transparentpng.com/thumb/mario/aT5K6w-super-mario-bros-cloud-transparent-background.png');
            background-repeat: no-repeat;
            background-position: 10% 15%, 85% 25%;
            background-size: 150px, 100px;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Contenedor principal del juego */
        #game-container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
        }
        
        /* Contenedor del Logo */
        #logo-container {
            margin-bottom: 10px;
        }
        #logo {
            max-width: 80%;
            height: auto;
            max-height: 100px;
        }

        /* Barra de mensajes e instrucciones */
        #message-bar {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px 20px;
            border-radius: 15px;
            border: 4px solid var(--mario-brown);
            box-shadow: 0 6px var(--mario-brown);
            text-align: center;
            font-size: clamp(1rem, 3.5vw, 1.5rem);
            line-height: 1.5;
        }

        /* Barra de estado (nivel, vidas, m√∫sica) */
        #status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            font-size: clamp(0.9rem, 3vw, 1.2rem);
            padding: 0 10px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .heart {
            color: var(--mario-red);
            font-size: 1.5em;
        }
        #music-toggle-btn {
            background: none;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Tablero de juego con los bloques */
        #game-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--block-size), 1fr));
            gap: 20px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            position: relative;
        }

        /* Estilo de los bloques '?' */
        .block {
            width: var(--block-size);
            height: var(--block-size);
            background-color: var(--mario-yellow);
            border: 5px solid var(--mario-brown);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(1.8rem, 5vw, 2.5rem);
            color: white;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.7);
            cursor: pointer;
            position: relative;
            box-shadow: inset -4px -4px 0px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s, background-color 0.2s;
        }
        .block:active {
            transform: translateY(2px);
        }
        .block.correct {
            animation: correct-jump 0.3s ease-out;
        }
        .block.used {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .block-content {
            position: relative;
            z-index: 1;
        }

        /* Personaje de Mario */
        #mario {
            width: 60px;
            height: 80px;
            background-image: url('https://i.imgur.com/J3337sE.png');
            background-size: contain;
            background-repeat: no-repeat;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.5s ease-in-out, bottom 0.5s ease-in-out;
            z-index: 10;
        }

        /* Modal para mensajes de fin de juego o nivel */
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #modal-content {
            background-color: var(--mario-blue);
            padding: 40px;
            border-radius: 20px;
            border: 5px solid white;
            text-align: center;
            max-width: 90%;
        }
        #modal-message {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        #modal-button {
            background-color: var(--grass-green);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            border: 4px solid white;
            font-family: var(--font-family);
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 5px 0 #2E8B57;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        #modal-button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #2E8B57;
        }

        /* Animaciones */
        @keyframes correct-jump {
            0% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <audio id="background-music" loop src=""></audio>

    <div id="game-container">
        <div id="logo-container">
            <img id="logo" src="https://placehold.co/300x100/FFFFFF/E52521?text=ZURE+LOGOA" alt="Jokoaren Logoa">
        </div>

        <div id="status-bar">
            <div class="status-item" id="level-display">Maila: 1</div>
            <div class="status-item" id="lives-display">
                <span class="heart">‚ù§</span><span class="heart">‚ù§</span><span class="heart">‚ù§</span>
            </div>
            <div class="status-item" id="music-control">
                <button id="music-toggle-btn">üîä</button>
            </div>
        </div>
        <div id="message-bar">Ongi etorri! Egin klik blokeetan ordenan.</div>
        <div id="game-board"></div>
        <div id="mario"></div>
    </div>

    <div id="modal" onclick="event.target === this && hideModal()">
        <div id="modal-content">
            <div id="modal-message"></div>
            <button id="modal-button"></button>
        </div>
    </div>

    <script>
        // --- JOKOAREN KONFIGURAZIOA ---
        const colorMap = {
            GORRIA: { name: 'GORRIA', hex: '#E52521' },
            URDINA: { name: 'URDINA', hex: '#3A5CFF' },
            BERDEA: { name: 'BERDEA', hex: '#4CAF50' },
            HORIA: { name: 'HORIA', hex: '#F7B000' },
            LARANJA: { name: 'LARANJA', hex: '#FFA500' },
            MOREA: { name: 'MOREA', hex: '#800080' },
        };
        const colorNames = Object.keys(colorMap);

        const gameConfig = {
            initialLives: 3,
            levels: [
                // Oinarrizkoak
                { type: 'sequence', values: [1, 2, 3], distractors: 3, message: 'Egin salto 1etik 3ra ordenan' }, // 1
                { type: 'color_find', color: 'GORRIA', count: 3, distractors: 4, message: 'Aurkitu 3 bloke GORRI' }, // 2
                { type: 'sequence', values: [1, 2, 3, 4, 5], distractors: 3, message: 'Orain 1etik 5era' }, // 3
                { type: 'even', count: 4, max: 10, distractors: 4, message: 'Salto egin zenbaki BIKOITIETAN!' }, // 4
                { type: 'odd', count: 4, max: 10, distractors: 4, message: 'Orain zenbaki BAKOITIETAN!' }, // 5
                // Zailtasun ertaina
                { type: 'color_sequence', values: ['GORRIA', 'URDINA', 'BERDEA'], distractors: 4, message: 'Jarraitu sekuentzia: GORRI, URDIN, BERDE' }, // 6
                { type: 'sequence', values: [8, 7, 6, 5], distractors: 4, message: 'Atzerantz! 8tik 5era' }, // 7
                { type: 'addition', count: 4, maxNum: 5, distractors: 4, message: 'Ebatzi GEHIKETAK!' }, // 8
                { type: 'sequence_by', start: 2, step: 2, count: 5, distractors: 3, message: '2tik 2ra zenbatzen' }, // 9
                { type: 'color_find', color: 'BERDEA', count: 4, distractors: 5, message: 'Aurkitu 4 bloke BERDE' }, // 10
                // Zailagoak
                { type: 'subtraction', count: 4, maxNum: 10, distractors: 4, message: 'Ebatzi KENKETAK!' }, // 11
                { type: 'sequence_by', start: 5, step: 5, count: 4, distractors: 4, message: '5etik 5era zenbatzen' }, // 12
                { type: 'sequence', values: [11, 12, 13, 14, 15], distractors: 4, message: 'Jarraitu 11tik 15era!' }, // 13
                { type: 'color_sequence', values: ['HORIA', 'BERDEA', 'URDINA', 'GORRIA'], distractors: 3, message: 'Sekuentzia luzeagoa!' }, // 14
                { type: 'addition', count: 5, maxNum: 10, distractors: 4, message: 'Gehiketa zailagoak!' }, // 15
                // Aditu maila
                { type: 'sequence_by', start: 10, step: 10, count: 5, distractors: 3, message: '10etik 10era, 50era arte!' }, // 16
                { type: 'subtraction', count: 5, maxNum: 15, distractors: 4, message: 'Kenketa gehiago!' }, // 17
                { type: 'sequence', values: [20, 19, 18, 17, 16, 15], distractors: 4, message: 'Atzerantz 20tik!' }, // 18
                { type: 'color_find', color: 'URDINA', count: 5, distractors: 5, message: 'Aurkitu 5 bloke URDIN' }, // 19
                { type: 'mixed_ops', count: 5, maxNum: 12, distractors: 4, message: 'Azken erronka: ebatzi denak!' }, // 20
            ]
        };

        // --- JOKOAREN EGOERA ---
        let gameState = {
            currentLevel: 0,
            lives: gameConfig.initialLives,
            sequence: [],
            currentStep: 0,
            boardLocked: false,
            musicPlaying: false
        };

        // --- DOM-EKO ELEMENTUAK ---
        const dom = {
            gameBoard: document.getElementById('game-board'),
            messageBar: document.getElementById('message-bar'),
            levelDisplay: document.getElementById('level-display'),
            livesDisplay: document.getElementById('lives-display'),
            mario: document.getElementById('mario'),
            modal: document.getElementById('modal'),
            modalMessage: document.getElementById('modal-message'),
            modalButton: document.getElementById('modal-button'),
            musicToggleBtn: document.getElementById('music-toggle-btn'),
            backgroundMusic: document.getElementById('background-music')
        };

        // --- SOINUAK ---
        const sounds = {
            jump: new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }).toDestination(),
            coin: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination(),
            wrong: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 } }).toDestination(),
            levelUp: new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.1 } }).toDestination(),
            gameOver: new Tone.Synth({ oscillator: { type: 'fmsquare' }, envelope: { attack: 0.1, decay: 0.8, sustain: 0, release: 0.1 } }).toDestination()
        };

        // --- LOGIKA NAGUSIA ---

        function startGame() {
            gameState.currentLevel = 0;
            gameState.lives = gameConfig.initialLives;
            gameState.boardLocked = false;
            updateLivesDisplay();
            setupLevel();
        }

        function setupLevel() {
            gameState.currentStep = 0;
            gameState.boardLocked = false;
            dom.gameBoard.innerHTML = '';

            const levelData = gameConfig.levels[gameState.currentLevel];
            if (!levelData) {
                winGame();
                return;
            }

            dom.messageBar.textContent = levelData.message;
            dom.levelDisplay.textContent = `Maila: ${gameState.currentLevel + 1}`;
            
            let correctItems = [];
            let displayItems = [];
            
            switch(levelData.type) {
                case 'sequence':
                case 'sequence_by':
                case 'even':
                case 'odd':
                    correctItems = generateNumberSequence(levelData);
                    displayItems = [...correctItems, ...generateDistractors(correctItems, levelData.distractors, levelData.max || 25)];
                    break;
                case 'addition':
                case 'subtraction':
                case 'mixed_ops':
                    correctItems = generateMathProblems(levelData);
                    const mathDistractors = generateDistractors(correctItems.map(p => p.answer), levelData.distractors, levelData.maxNum * 2);
                    displayItems = [...correctItems, ...mathDistractors.map(d => ({ text: d, answer: d, type: 'distractor' }))];
                    break;
                case 'color_find':
                    correctItems = Array(levelData.count).fill(levelData.color);
                    const colorDistractors = generateDistractors(correctItems, levelData.distractors, 0, colorNames);
                    displayItems = [...correctItems, ...colorDistractors];
                    break;
                case 'color_sequence':
                    correctItems = levelData.values;
                    const colorSeqDistractors = generateDistractors(correctItems, levelData.distractors, 0, colorNames);
                    displayItems = [...correctItems, ...colorSeqDistractors];
                    break;
            }
            
            gameState.sequence = correctItems;
            shuffleArray(displayItems);
            
            displayItems.forEach(item => createBlock(item, levelData.type));
        }

        function createBlock(item, type) {
            const block = document.createElement('div');
            block.classList.add('block');
            const content = document.createElement('span');
            content.classList.add('block-content');
            
            let blockValue, blockColor;

            if (typeof item === 'object' && item.text) { // Math problem
                content.textContent = item.text;
                blockValue = item.answer;
            } else if (colorNames.includes(item)) { // Color level
                blockValue = item;
                blockColor = colorMap[item].hex;
                block.style.backgroundColor = blockColor;
                block.dataset.color = item;
            } else { // Number level
                content.textContent = item;
                blockValue = item;
            }

            block.appendChild(content);
            block.addEventListener('click', () => handleBlockClick(block, blockValue));
            dom.gameBoard.appendChild(block);
        }

        function handleBlockClick(blockElement, blockValue) {
            if (gameState.boardLocked || blockElement.classList.contains('used')) return;

            const levelData = gameConfig.levels[gameState.currentLevel];
            let expectedValue = gameState.sequence[gameState.currentStep];
            if (typeof expectedValue === 'object') expectedValue = expectedValue.answer;

            let isCorrect = false;
            if (levelData.type === 'color_find') {
                if (blockValue === levelData.color) isCorrect = true;
            } else if (levelData.type === 'color_sequence') {
                if (blockValue === expectedValue) isCorrect = true;
            } else {
                if (blockValue === expectedValue) isCorrect = true;
            }

            if (isCorrect) {
                handleCorrectClick(blockElement);
            } else {
                handleWrongClick();
            }
        }
        
        function handleCorrectClick(blockElement) {
            sounds.coin.triggerAttackRelease('G5', '0.1');
            blockElement.classList.add('used', 'correct');
            animateMarioJump(blockElement);
            gameState.currentStep++;
            
            if (gameState.currentStep >= gameState.sequence.length) {
                gameState.boardLocked = true;
                setTimeout(levelUp, 1000);
            }
        }

        function handleWrongClick() {
            sounds.wrong.triggerAttackRelease('C3', '0.5');
            gameState.lives--;
            updateLivesDisplay();
            if (gameState.lives <= 0) {
                gameState.boardLocked = true;
                setTimeout(gameOver, 500);
            }
        }
        
        function levelUp() {
            sounds.levelUp.triggerAttackRelease('C5', '0.4');
            gameState.currentLevel++;
            showModal('Maila gaindituta!', 'Hurrengo Maila', setupLevel);
        }

        function gameOver() {
            sounds.gameOver.triggerAttackRelease('C2', '0.8');
            showModal('Uh oh! Jokoa amaitu da', 'Berriro Jokatu', startGame);
        }
        
        function winGame() {
            showModal('Zorionak! Irabazi duzu!', 'Berriro Jokatu', startGame);
        }

        // --- FUNTZIO LAGUNTZAILEAK ---

        function updateLivesDisplay() {
            dom.livesDisplay.innerHTML = Array(gameState.lives).fill('<span class="heart">‚ù§</span>').join('');
        }
        
        function animateMarioJump(targetBlock) {
            const boardRect = dom.gameBoard.getBoundingClientRect();
            const blockRect = targetBlock.getBoundingClientRect();
            const marioHeight = dom.mario.offsetHeight;
            const targetX = blockRect.left - boardRect.left + (blockRect.width / 2);
            dom.mario.style.left = `${targetX}px`;
            dom.mario.style.bottom = `${dom.gameBoard.offsetHeight - blockRect.top + boardRect.top}px`;
            sounds.jump.triggerAttackRelease('C4', '0.1');
        }

        function showModal(message, buttonText, buttonAction) {
            dom.modalMessage.textContent = message;
            dom.modalButton.textContent = buttonText;
            dom.modalButton.onclick = () => {
                hideModal();
                buttonAction();
            };
            dom.modal.style.display = 'flex';
        }

        function hideModal() { dom.modal.style.display = 'none'; }
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        
        function generateNumberSequence(levelData) {
            switch(levelData.type) {
                case 'sequence': return levelData.values;
                case 'sequence_by': return Array.from({length: levelData.count}, (_, i) => levelData.start + i * levelData.step);
                case 'even': return generateNumberSet(levelData.count, levelData.max, n => n % 2 === 0 && n > 0);
                case 'odd': return generateNumberSet(levelData.count, levelData.max, n => n % 2 !== 0);
                default: return [];
            }
        }

        function generateMathProblems(levelData) {
            const problems = [];
            for (let i = 0; i < levelData.count; i++) {
                let n1, n2, answer, text;
                const forceAddition = levelData.type === 'addition' || (levelData.type === 'mixed_ops' && Math.random() > 0.5);
                
                if (forceAddition) {
                    n1 = Math.ceil(Math.random() * levelData.maxNum);
                    n2 = Math.ceil(Math.random() * levelData.maxNum);
                    answer = n1 + n2;
                    text = `${n1}+${n2}`;
                } else { // Subtraction
                    n1 = Math.ceil(Math.random() * levelData.maxNum) + levelData.maxNum;
                    n2 = Math.ceil(Math.random() * levelData.maxNum);
                    answer = n1 - n2;
                    text = `${n1}-${n2}`;
                }
                problems.push({ text, answer });
            }
            return problems;
        }

        function generateNumberSet(count, max, condition) {
            const numbers = new Set();
            while(numbers.size < count) {
                const rand = Math.floor(Math.random() * max) + 1;
                if(condition(rand)) numbers.add(rand);
            }
            return Array.from(numbers).sort((a,b) => a-b);
        }

        function generateDistractors(correctItems, count, max, itemPool) {
            const distractors = new Set();
            const pool = itemPool || Array.from({length: max}, (_, i) => i + 1);
            while(distractors.size < count) {
                const randItem = pool[Math.floor(Math.random() * pool.length)];
                if(!correctItems.includes(randItem)) distractors.add(randItem);
            }
            return Array.from(distractors);
        }
        
        function toggleMusic() {
            if (dom.backgroundMusic.src && dom.backgroundMusic.src !== window.location.href) {
                if (gameState.musicPlaying) {
                    dom.backgroundMusic.pause();
                    dom.musicToggleBtn.textContent = 'üîá';
                } else {
                    dom.backgroundMusic.play().catch(e => console.error("Musika ezin da erreproduzitu:", e));
                    dom.musicToggleBtn.textContent = 'üîä';
                }
                gameState.musicPlaying = !gameState.musicPlaying;
            } else {
                console.log("Ez da musikaren URL-rik ezarri.");
            }
        }

        // --- JOKOAREN HASIERA ---
        window.onload = () => {
            dom.musicToggleBtn.addEventListener('click', toggleMusic);
            showModal('Zenbakien Jauziak', 'Jolasten Hasi!', async () => {
                await Tone.start();
                startGame();
            });
        };

    </script>
</body>
</html>
